#!/usr/bin/env node

/**
 * blaze - 0.0.3 - PHP's built-in web server as a zero-configuration development server.
 *
 * @author Ian Kennington Walter (http://ianvonwalter.com)
 */

/**
 * Module dependencies.
 */
var blaze = require('commander'),
    exec = require('child_process').exec,
    spawn = require('child_process').spawn;

blaze
  .version('0.0.2')
  .option('-p, --port [number]', 'Specify port [8888]', '8888')
  .parse(process.argv);

exec('which php', function (error, stdout, stderr) {
  if (error !== null) {
    console.log('Error: ' + error);
  }

  // Replace newline
  stdout = stdout.replace(/(\r\n|\n|\r)/gm,"");

  var server = spawn(stdout, ['-S', '0.0.0.0:' + blaze.port, '-c',
    __dirname + '/router.ini', '-t', process.cwd(), __dirname + '/router.php']);

  console.log('============');
  console.log('Blaze ' + blaze.version());
  console.log('Your server is listening at http://localhost:' + blaze.port +
  '/');
  console.log('Press Ctl+C to stop the server');
  console.log('============');

  server.stdout.setEncoding('utf8');
  server.stdout.on('data', function (data) {
    process.stdout.write(data);
  });

  server.stderr.setEncoding('utf8');
  server.stderr.on('data', function (data) {
    process.stdout.write(data);
  });

  server.on('close', function (code) {
    console.log('Child process exited with code', code);
  });
});
